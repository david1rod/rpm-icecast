From 4729f966c31c3ed995e65bdd4eee1b7b56aa9397 Mon Sep 17 00:00:00 2001
From: Gregor Riepl <Gregor.Riepl@swisstxt.ch>
Date: Mon, 23 May 2016 18:52:17 +0200
Subject: [PATCH] Fixed empty buffer bug when an HTTP range request is made

---
 src/fserve.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/src/fserve.c b/src/fserve.c
index 276f07b..5207c1e 100644
--- a/src/fserve.c
+++ b/src/fserve.c
@@ -883,6 +883,8 @@ int fserve_setup_client_fb (client_t *client, fbinfo *finfo)
 {
     fh_node *fh = &no_file;
     int ret = 0;
+    refbuf_t *refbuf;
+    ssize_t bytes;
 
     if (finfo)
     {
@@ -970,6 +972,14 @@ int fserve_setup_client_fb (client_t *client, fbinfo *finfo)
     if (client->check_buffer == NULL)
         client->check_buffer = format_generic_write_to_client;
 
+    if (client->flags & CLIENT_RANGE_END)
+    {
+        refbuf = client->refbuf->next;
+        bytes = pread (fh->f, refbuf->data, refbuf->len, client->intro_offset);
+        if (bytes < 0)
+            return -1;
+    }
+    
     client->ops = &buffer_content_ops;
     client->flags &= ~CLIENT_HAS_INTRO_CONTENT;
     client->flags |= CLIENT_IN_FSERVE;
-- 
2.7.4

